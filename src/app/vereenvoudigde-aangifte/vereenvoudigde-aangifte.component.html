<!-- Data Management Controls -->
<div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
  <div class="flex justify-between items-center mb-3">
    <h3 class="text-lg font-semibold text-gray-900">Data Management</h3>
    <div class="text-xs text-gray-500">
      Last saved: {{ lastSaved | date:'short' }}
    </div>
  </div>
  <div class="flex flex-wrap gap-2">
    <button 
      class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors"
      (click)="resetToDefaults()">
      Reset to Defaults
    </button>
    <button 
      class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors"
      (click)="exportData()">
      Export Data
    </button>
    <button 
      class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600 transition-colors"
      (click)="showImportDialog = true">
      Import Data
    </button>
    <button 
      class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors"
      (click)="clearData()">
      Clear All Data
    </button>
  </div>
  
  <!-- Import Dialog -->
  <div *ngIf="showImportDialog" class="mt-4 p-4 bg-gray-50 rounded-lg">
    <h4 class="font-medium text-gray-900 mb-2">Import Data</h4>
    <textarea 
      class="w-full h-32 p-2 border border-gray-300 rounded text-sm font-mono"
      placeholder="Paste JSON data here..."
      [(ngModel)]="importDataText">
    </textarea>
    <div class="flex gap-2 mt-2">
      <button 
        class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors"
        (click)="importData()">
        Import
      </button>
      <button 
        class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600 transition-colors"
        (click)="showImportDialog = false">
        Cancel
      </button>
    </div>
    <div *ngIf="importMessage" class="mt-2 text-sm" [ngClass]="importSuccess ? 'text-green-600' : 'text-red-600'">
      {{ importMessage }}
    </div>
  </div>
</div>

<!-- Top section: Two columns, same height, no extra whitespace -->
<div class="flex flex-col lg:flex-row gap-4 w-full mb-4">
  <!-- Left column: Invoermethode (3 cards + info box) -->
  <div class="w-full lg:w-1/2 flex flex-col bg-white border border-teal-200 rounded-lg p-4 h-[220px]">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Invoermethode</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 flex-1">
      <div class="border rounded-lg p-2 cursor-pointer transition-all flex flex-col items-center justify-center h-full"
           [ngClass]="inputMethod === 'manual' ? 'border-teal-500 bg-teal-50' : 'border-gray-200 hover:border-gray-300'"
           (click)="selectMethod('manual')">
        <div class="flex items-center space-x-3">
          <span class="text-2xl">üìÑ</span>
          <div>
            <h4 class="font-medium text-gray-900 text-sm">Handmatige invoer</h4>
            <p class="text-xs text-gray-600">Voer bekende bedragen direct in</p>
          </div>
        </div>
      </div>
      <div class="border rounded-lg p-2 cursor-pointer transition-all flex flex-col items-center justify-center h-full"
           [ngClass]="inputMethod === 'previous' ? 'border-teal-500 bg-teal-50' : 'border-gray-200 hover:border-gray-300'"
           (click)="selectMethod('previous')">
        <div class="flex items-center space-x-3">
          <span class="text-2xl">üóÇÔ∏è</span>
          <div>
            <h4 class="font-medium text-gray-900 text-sm">Vorig jaar als basis</h4>
            <p class="text-xs text-gray-600">Start met cijfers van vorige aangifte</p>
          </div>
        </div>
      </div>
      <div class="border rounded-lg p-2 cursor-pointer transition-all flex flex-col items-center justify-center h-full"
           [ngClass]="inputMethod === 'upload' ? 'border-teal-500 bg-teal-50' : 'border-gray-200 hover:border-gray-300'"
           (click)="selectMethod('upload')">
        <div class="flex items-center space-x-3">
          <span class="text-2xl">‚¨ÜÔ∏è</span>
          <div>
            <h4 class="font-medium text-gray-900 text-sm">Voorlopige P&V</h4>
            <p class="text-xs text-gray-600">Upload tussentijdse proef- en saldibalans</p>
          </div>
        </div>
      </div>
    </div>
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 mt-2 mb-2">
      <p class="text-xs text-blue-800">
        <ng-container [ngSwitch]="inputMethod">
          <ng-container *ngSwitchCase="'manual'">
            <strong>Handmatige invoer:</strong> Voer de verwachte bedragen direct in voor een snelle berekening. U kunt deze waarden op elk moment aanpassen.
          </ng-container>
          <ng-container *ngSwitchCase="'previous'">
            <strong>Vorig jaar als basis:</strong> De cijfers van vorig jaar worden overgenomen als basis. U kunt deze aanpassen om een accuratere inschatting te maken voor het huidige boekjaar.
          </ng-container>
          <ng-container *ngSwitchCase="'upload'">
            <strong>Extrapolatie:</strong> Resultaat voor 9 maanden ge√´xtrapoleerd naar 12 maanden = ‚Ç¨90.000
          </ng-container>
        </ng-container>
      </p>
    </div>
  </div>
  <!-- Right column: Key Elements section -->
  <div class="w-full lg:w-1/2 flex flex-col bg-white border border-teal-200 rounded-lg p-4 h-[220px]">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Key Elements</h3>
    <!-- Checkboxes above the cards -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-2 w-full mb-4">
      <div class="space-y-2">
        <label class="flex items-center space-x-2 cursor-pointer group">
          <input type="checkbox" [(ngModel)]="canUseReducedRate" (change)="onTaxRateCheckboxChange()" class="w-4 h-4 rounded border-blue-300 text-blue-600 focus:ring-blue-500 transition-colors" />
          <span class="text-xs text-blue-800 group-hover:text-blue-900 transition-colors">De vennootschap kan bij uw weten aanspraak maken op het verminderd tarief van 20% op de eerste schijf van 100.000 euro (code 1701)</span>
        </label>
        <label class="flex items-center space-x-2 cursor-pointer group">
          <input type="checkbox" [(ngModel)]="isSmallCompanyFirstThreeYears" (change)="onTaxRateCheckboxChange()" class="w-4 h-4 rounded border-blue-300 text-blue-600 focus:ring-blue-500 transition-colors" />
          <span class="text-xs text-blue-800 group-hover:text-blue-900 transition-colors">Deze aangifte heeft betrekking op √©√©n van de eerste drie boekjaren vanaf de oprichting van de vennootschap die een 'kleine vennootschap' is (code 1801)</span>
        </label>
      </div>
    </div>
    <!-- Two summary cards side by side -->
    <div class="flex flex-row gap-4 flex-1 min-h-0">
      <div class="bg-cyan-50 border border-cyan-200 rounded-lg p-2 flex-1 flex flex-col items-center justify-center h-full min-h-0">
        <h4 class="text-sm font-semibold text-gray-900 mb-1 text-center">Vermeerdering wegens ontoereikende VA</h4>
        <div class="text-base font-bold text-cyan-700 text-center">
          {{ (calculationResults?.prepaymentPenalty || 0) | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}
        </div>
      </div>
      <div class="bg-rose-50 border border-rose-200 rounded-lg p-2 flex-1 flex flex-col items-center justify-center h-full min-h-0">
        <h4 class="text-sm font-semibold text-gray-900 mb-1 text-center">Te betalen belastingen</h4>
        <div class="text-base font-bold text-rose-700 text-center">
          {{ (calculationResults?.finalTaxDue || 0) | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="flex flex-col lg:flex-row gap-8 items-stretch w-full">
  <!-- Left: Vereenvoudigde aangifte -->
  <div class="bg-white border rounded-xl shadow-sm p-6 flex-1 min-h-full flex flex-col w-full lg:w-1/2">
    <h3 class="text-xl font-bold text-gray-900 mb-6">Vereenvoudigde aangifte</h3>

    <div class="space-y-6">
      <div *ngFor="let section of declarationSections" class="block">
        <!-- Section with fields but no title (like code 1420) -->
        <div *ngIf="!section.isFoldable && section.title === null && section.fields.length > 0" class="space-y-4">
          <div *ngFor="let field of section.fields" class="flex items-center mb-2">
            <span class="flex-1 text-gray-700">{{ field.label }}</span>
            <span *ngIf="field.code" class="text-xs bg-teal-100 text-teal-800 px-2 py-1 rounded mr-2">{{ field.code }}</span>
            <app-formatted-number-input
              [fieldName]="field.code || field.label"
              [placeholder]="'0,00'"
              [(ngModel)]="field.value"
              (valueChange)="onFieldValueChange(field, $event)">
            </app-formatted-number-input>
          </div>
        </div>
        
        <!-- Subtotal Section only (like code 1430) -->
        <div *ngIf="section.subtotal && section.fields.length === 0" class="flex justify-between items-center py-3 mt-4 px-4 border-t border-gray-200">
            <span class="text-base font-medium text-gray-900 underline text-left">{{ section.subtotal.label }}</span>
            <span class="text-base font-medium text-gray-900 underline text-right">{{ section.subtotal.value | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</span>
        </div>

        <!-- Foldable Section -->
        <div *ngIf="section.isFoldable">
          <div class="flex justify-between items-center mb-3 cursor-pointer select-none transition-colors rounded hover:bg-teal-50" (click)="section.isOpen = !section.isOpen">
            <h4 class="font-medium text-gray-900">{{ section.title }}</h4>
            <span class="text-sm font-medium flex items-center">
              <span *ngIf="section.title === 'Aftrekken resterende winst - korfbeperking' && calculationResults" class="mr-2">{{ calculationResults.limitedSection4Total | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</span>
              <span *ngIf="section.title !== 'Aftrekken resterende winst - korfbeperking' && section.total" class="mr-2">{{ section.total.value | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</span>
              <svg *ngIf="!section.isOpen" class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14m7-7H5"/></svg>
              <svg *ngIf="section.isOpen" class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 12H5"/></svg>
            </span>
          </div>
          <div *ngIf="section.isOpen">
            <div class="space-y-2 bg-teal-50 p-4 rounded">
              <div *ngFor="let field of section.fields" class="flex items-center mb-2">
                <span class="flex-1 text-gray-700">{{ field.label }}</span>
                <span *ngIf="field.code" class="text-xs bg-teal-100 text-teal-800 px-2 py-1 rounded mr-2">{{ field.code }}</span>
                <app-formatted-number-input
                  [fieldName]="field.code || field.label"
                  [placeholder]="'0,00'"
                  [(ngModel)]="field.value"
                  (valueChange)="onFieldValueChange(field, $event)">
                </app-formatted-number-input>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Right: Te betalen belasting -->
  <div class="bg-white border rounded-xl shadow-sm p-6 flex-1 min-h-full flex flex-col w-full lg:w-1/2">
    <h3 class="text-xl font-bold text-gray-900 mb-4">Berekening</h3>
    
    <!-- Loading indicator -->
    <div *ngIf="isLoading" class="flex items-center justify-center py-4">
      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
      <span class="ml-2 text-blue-600">Berekenen...</span>
    </div>

    <!-- Results display -->
    <div *ngIf="!isLoading" class="space-y-6">
      <!-- Berekening section -->
      <div class="border rounded mb-4">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="border-b bg-gray-50">
              <th class="px-3 py-2 text-left font-medium w-1/2">Berekening</th>
              <th class="px-3 py-2 text-center font-medium w-16">Code</th>
              <th class="px-3 py-2 text-right font-medium w-24">Bedrag</th>
              <th class="px-3 py-2 text-right font-medium w-20">Tarief</th>
              <th class="px-3 py-2 text-right font-medium w-24">Resultaat</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="!calculationResults || !calculationResults.calculationRows || calculationResults.calculationRows.length === 0">
              <td colspan="5" class="px-3 py-4 text-center text-gray-500">Berekeningen worden geladen...</td>
            </tr>
            <tr *ngFor="let row of calculationResults?.calculationRows" class="border-b last:border-b-0 hover:bg-gray-50">
              <td class="px-3 py-2 text-sm">{{ row.description }}</td>
              <td class="px-3 py-2 text-center">{{ row.code }}</td>
              <td class="px-3 py-2 text-right">{{ row.amount | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</td>
              <td class="px-3 py-2 text-right">{{ row.rate !== null ? (row.rate | number:'1.2-2') + '%' : '' }}</td>
              <td class="px-3 py-2 text-right font-medium">{{ row.result | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</td>
            </tr>
            <tr class="font-bold bg-gray-100 border-t-2" *ngIf="calculationResults">
              <td class="px-3 py-2" colspan="4">Saldo 1</td>
              <td class="px-3 py-2 text-right">{{ calculationResults.calculationTotal | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Verrekenbare voorheffingen section -->
      <div class="mb-4">
        <h4 class="text-md font-semibold text-gray-900 mb-2">Verrekenbare voorheffingen</h4>
        <div class="border rounded">
          <table class="min-w-full text-sm">
            <tbody>
              <tr *ngIf="!calculationResults || !calculationResults.voorheffingenRows || calculationResults.voorheffingenRows.length === 0">
                <td colspan="5" class="px-3 py-4 text-center text-gray-500">Geen voorheffingen</td>
              </tr>
              <tr *ngFor="let row of calculationResults?.voorheffingenRows" class="border-b last:border-b-0 hover:bg-gray-50">
                <td class="px-3 py-2 text-sm w-1/2">{{ row.description }}</td>
                <td class="px-3 py-2 text-center w-16">{{ row.code }}</td>
                <td class="px-3 py-2 text-right w-24">&nbsp;</td>
                <td class="px-3 py-2 text-right w-20">&nbsp;</td>
                <td class="px-3 py-2 text-right font-medium w-24">{{ row.result | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Resultaat section -->
      <div class="mb-4">
        <h4 class="text-md font-semibold text-gray-900 mb-2">Resultaat</h4>
        <div class="border rounded">
          <table class="min-w-full text-sm">
            <tbody>
              <tr *ngIf="!calculationResults || !calculationResults.resultRows || calculationResults.resultRows.length === 0">
                <td colspan="5" class="px-3 py-4 text-center text-gray-500">Geen resultaten</td>
              </tr>
              <tr *ngFor="let row of calculationResults?.resultRows" class="border-b last:border-b-0 hover:bg-gray-50">
                <td class="px-3 py-2 text-sm w-1/2">{{ row.description }}</td>
                <td class="px-3 py-2 text-center w-16">{{ row.code }}</td>
                <td class="px-3 py-2 text-right w-24">{{ row.amount | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</td>
                <td class="px-3 py-2 text-right w-20">{{ row.rate !== null ? (row.rate | number:'1.2-2') + '%' : '' }}</td>
                <td class="px-3 py-2 text-right font-medium w-24">{{ row.result | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="flex justify-between items-center mt-3 p-3 border-t-2 border-gray-300 bg-gray-50 rounded-b text-lg font-bold text-gray-900">
          <span>Te betalen belastingen</span>
          <span>{{ (calculationResults?.finalTaxPayable || 0) | currency:'EUR':'symbol':'1.2-2':'nl-BE' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
